<html>

<head>
    <link href='https://fonts.googleapis.com/css?family=Overpass+Mono' rel='stylesheet'>
    <link rel="stylesheet" type="text/css" href="style/style.css" media="screen" />

    <style>
        .gray {
            color: gray;
        }

        #container-top {
            height: 75%;
            overflow: hidden;
        }

        #preprocessor_output {
            width: 30%;
            overflow: scroll;
        }

        #editor,
        #editor-nol,
        #preprocessor_output,
        #assembler_output {
            color: white;
            float: left;
            height: 100%;
            background: black;
        }

        #assembler_output {
            width: 20%;
            overflow: scroll;
        }

        #editor {
            width: calc(50% - 4em - 32px);
            overflow: scroll;
            white-space: nowrap;
        }

        #editor-nol,
        .num {
            color: #aaaaaa;
        }

        #editor-nol {
            width: 4em;
            text-align: right;
            padding-right: 1em;
        }

        #preprocessor_output {
            background: #101010;
        }

        .v-spacer {
            width: 8px;
            background: black;
            float: left;
            height: 100%;
        }

        #log {
            clear: both;
            height: calc(25% - 32px);
            overflow: scroll;
            background: #101010;
        }

    </style>

    <script src='rc-core.js'></script>
    <script src='rc-math.js'></script>
    <script src='rc-constants.js'></script>
    <script src='rc-address-modes.js'></script>
    <script src='rc-preprocessor.js'></script>
    <script src='rc-assembler.js'></script>
    <script src='rc-classes.js'></script>
    <script src='rc-instruction-set.js'></script>
    <script src='rc-instruction.js'></script>

    <script>

        var modified = false

        String.prototype.html = function () {
            const escape = [
                ['>', '&gt;'],
                ['<', '&lt;'],
            ]

            var html = this

            escape.forEach(item => {
                html = html.replace(item[0], item[1])    
            })

            return html
        }

        function number_text(text) {
            var s = ''

            for (var i = 0; i < text.length; i++) {
                n = (1 + i + '').padStart(3)

                if (i % 10 == 9) {
                    s += `<u>${n}</u> ${text[i]}<br>`
                } else {
                    s += `<span class='num'>${n}</span> ${text[i]}<br>`
                }
            }

            return s
        }

        function preprocess() {
            var code = document.getElementById('editor').value
            var prepro = new Preprocessor()
            var output = prepro.preprocess(code)

            var content = number_text(output.code.split('\n'))
            document.getElementById('preprocessor_output').innerHTML = content

            html = '<span class="gray">'

            if (output.errors.length) {
                html += `<b>PREPROCESSOR ERRORS:</b>\n${output.errors.join('\n').html()}</b>\n\n`
            }

            if (output.warnings.length) {
                html += `<i>PREPROCESSOR WARNINGS:</i>\n${output.warnings.join('\n').html()}`
            }

            html += '</span>'

            document.getElementById('log').innerHTML = html

            return output
        }

        function assemble(code) {
            var assembler = new Assembler()
            var output = assembler.assemble(code)
            var content = number_text(output.listing.split('\n'))

            document.getElementById('assembler_output').innerHTML = content

            var html = '<br><span class="gray">'

            if (output.errors.length) {
                html += `\n<b>ERRORS:</b>\n${output.errors.join('\n').html()}</b>\n\n`
            }

            if (output.warnings.length) {
                html += `<i>WARNINGS:</i>\n${output.warnings.join('\n').html()}`
            }

            html += '</span>'

            document.getElementById('log').innerHTML += html

            return output
        }

        function changed() {
            var p = preprocess()

            if (p.errors.length == 0) {
                var a = assemble(p.code)

                if (a.errors.length == 0) {
                    modified = true
                    document.getElementById('log').innerHTML +=
                        '<span class="yay">ASSEMBLED SUCCESSFULLY.</span><br>'
                }

                document.getElementById('save_button').hidden = (a.errors.length > 0)
            } else {
                document.getElementById('assembler_output').innerHTML =
                    '<b>Preprocessor errors prevented assembly.</b>'
                document.getElementById('save_button').hidden = true
            }

            renumber_lines()
        }

        function renumber_lines() {
            var n = document.getElementById('editor').value.split('\n').length
            var s = ''

            for (var i = 1; i <= n; i++) {
                if (i % 10 == 0) {
                    s += `<u>${i}</u><br>`
                }
                else {
                    s += `${i}<br>`
                }
            }

            document.getElementById('editor-nol').innerHTML = s
        }

        function save() {
            var code = document.getElementById('editor').value
            var name = document.getElementById('name').value
            name = '#WRRR_' + name.replace(/ /g, '_')

            localStorage.setItem(name, code)

            document.getElementById('save_button').hidden = true
        }

        function scrolled() {
            var y = document.getElementById('editor')
            var e = document.getElementById('editor-nol')
            e.style.height = y.scrollHeight
            e.style.marginTop = `-${y.scrollTop}px`
        }

    </script>

</head>

<body onload='changed()'>
    <div id='container-top'>
        <div id='editor-nol'></div>
        <textarea autocomplete='off' autocorrect='off' autocapitalize='off' spellcheck='false' id='editor' onkeyup='changed()' onscroll='scrolled()'></textarea>
        <script>

            code = `; mice
        org start
ptr     dat     #0     ,  #0
start   mov     #12    ,  ptr
loop    mov     @ptr   ,  <copy
        djn     loop   ,  ptr
        spl     @copy  ,  0
        add     #653   ,  copy
        jmz     start  ,  ptr
copy    dat     #0     ,  #833
    end`

            document.getElementById('editor').value = code

        </script>

        <div class='v-spacer'></div>
        <pre id='preprocessor_output'>preprocessor output</pre>
        <div class='v-spacer'></div>
        <pre id='assembler_output'>assembler output</pre>
    </div>

    <pre id='log'></pre>
    
    <div class='toolbar'>
        <input type='button' value='assemble' onclick='changed()'>
        <input type='button' value='write to local storage' onclick='save()' id='save_button'>
        <input type='text' placeholder='warrior name' id='name'>
    </div>
</body>

</html>