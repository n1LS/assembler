<html>

<head>
    <link href='https://fonts.googleapis.com/css?family=Overpass+Mono' rel='stylesheet'>
    <style>
        * {
            border: 0;
            font-family: 'Overpass Mono', monospace;
            font-size: 13px;
            line-height: 120%;
            border: 0;
            padding: 0;
            margin: 0;
            background: #101010;
        }

        ::-webkit-resizer,
        ::-webkit-scrollbar,
        ::-webkit-scrollbar-track,
        ::-webkit-scrollbar-button,
        ::-webkit-scrollbar-corner,
        ::-webkit-scrollbar-track-piece {
            background: #202020;
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 6px;
        }

        .gray {
            color: gray;
        }

        #container-top {
            height: 75%;
            overflow: hidden;
        }

        #preprocessor_output {
            width: 30%;
            overflow: scroll;
        }

        #editor,
        #editor-nol,
        #preprocessor_output,
        #assembler_output {
            color: white;
            float: left;
            height: 100%;
            background: black;
        }

        #assembler_output {
            width: 20%;
            overflow: scroll;
        }

        #editor {
            width: calc(50% - 4em - 32px);
            overflow: scroll;
        }

        #editor-nol,
        .num {
            color: #aaaaaa;
        }
        
        #editor-nol {
            width: 4em;
            text-align: right;
            padding-right: 1em;
        }

        #preprocessor_output {
            background: #101010;
        }

        input {
            height: 32px;
            padding: 8px;
            color: white;
            background: black;
        }

        .v-spacer {
            width: 8px;
            background: black;
            float: left;
            height: 100%;
        }

        #toolbar {
            background: #404040;
            height: 32px;
            overflow: hidden;
        }

        #log {
            clear: both;
            height: calc(25% - 32px);
            overflow: scroll;
            background: #101010;
        }

        u {
            color: #ffffff;
            text-decoration: none;
        }

        b {
            color: #e2004b;
        }

        i {
            color: #fecb00;
            font-style: normal;
        }

        .yay {
            color: #6bb324;
        }

    </style>

    <script src='rc-core.js'></script>
    <script src='rc-math.js'></script>
    <script src='rc-constants.js'></script>
    <script src='rc-address-modes.js'></script>
    <script src='rc-preprocessor.js'></script>
    <script src='rc-assembler.js'></script>
    <script src='rc-classes.js'></script>
    <script src='rc-instruction-set.js'></script>
    <script src='rc-instruction.js'></script>

    <script>

        var modified = false

        function number_text(text) {
            var s = ''

            for (var i = 0; i < text.length; i++) {
                n = (1 + i + '').padStart(3)

                if (i % 10 == 9) {
                    s += `<u>${n}</u> ${text[i]}<br>`
                } else {
                    s += `<span class='num'>${n}</span> ${text[i]}<br>`
                }
            }

            return s
        }

        function preprocess() {
            var code = document.getElementById('editor').value
            var prepro = new Preprocessor()
            var output = prepro.preprocess(code)

            var content = number_text(output.code.split('\n'))
            document.getElementById('preprocessor_output').innerHTML = content

            html = '<span class="gray">'

            if (output.errors.length) {
                html += `<b>PREPROCESSOR ERRORS:</b>\n${output.errors.join('\n')}</b>\n\n`
            }

            if (output.warnings.length) {
                html += `<i>PREPROCESSOR WARNINGS:</i>\n${output.warnings.join('\n')}`
            }

            html += '</span>'

            document.getElementById('log').innerHTML = html

            return output
        }

        function assemble(code) {
            var assembler = new Assembler()
            var output = assembler.assemble(code)
            var content = number_text(output.listing.split('\n'))

            document.getElementById('assembler_output').innerHTML = content

            var html = '<br><span class="gray">'

            if (output.errors.length) {
                html += `\n<b>ERRORS:</b>\n${output.errors.join('\n')}</b>\n\n`
            }

            if (output.warnings.length) {
                html += `<i>WARNINGS:</i>\n${output.warnings.join('\n')}`
            }

            html += '</span>'

            document.getElementById('log').innerHTML += html

            return output
        }

        function changed() {
            var p = preprocess()

            if (p.errors.length == 0) {
                var a = assemble(p.code)

                if (a.errors.length == 0) {
                    modified = true
                    document.getElementById('log').innerHTML += 
                        '<span class="yay">ASSEMBLED SUCCESSFULLY.</span><br>'
                }
                
                document.getElementById('save_button').hidden = (a.errors.length > 0)
            } else {
                document.getElementById('assembler_output').innerHTML =
                    '<b>Preprocessor errors prevented assembly.</b>'
                document.getElementById('save_button').hidden = true
            }

            renumber_lines()
        }

        function renumber_lines() {
            var n = document.getElementById('editor').value.split('\n').length
            var s = ''

            for (var i = 1; i <= n; i++) {
                if (i % 10 == 0) {
                    s += `<u>${i}</u><br>`
                }
                else {
                    s += `${i}<br>`
                }
            }

            document.getElementById('editor-nol').innerHTML = s
        }

        function save() {
            var code = document.getElementById('editor').value
            var name = document.getElementById('name').value
            name = '#WRRR_' + name.replace(/ /g, '_')

            localStorage.setItem(name, code)

            document.getElementById('save_button').hidden = true
        }

        function scrolled() {
            var y = document.getElementById('editor')
            var e = document.getElementById('editor-nol')
            e.style.height = y.scrollHeight
            e.style.marginTop = `-${y.scrollTop}px`
        }

    </script>

</head>

<body onload='changed()'>
    <div id='container-top'>
        <div id='editor-nol'></div>
        <textarea autocomplete='off' autocorrect='off' autocapitalize='off' spellcheck='false' id='editor' onkeyup='changed()' onscroll='scrolled()'>
;@redcode-n 
;@name Test Code
;@author np
;@description non-functional test code to check 
;how well the preprocessor works :-)
    org l√§bel üå≥
    mov 0, 1
null equ 0
win equ 42
l√§bel:  ADD #4, 3
    MOV 2, #1 ; comment
    MOV l√§bel, @2 ; comment
    JMP -2
    mov win win
    mov win+win win*null
base_pointer: DAT 0 0
base_pointer: DAT 0 0
    JMP base_pointer, 1
    JMP base_pointer, 1
    JMZ base_pointer+3
    JMZ 0*base_pointer, 0
lbel:   NOP ; duplicate label
    ;; comment lines
    DAT      #0, #l√§bel
    ;; moart commentsw 
    NOP
    END
    MOV 3, 1
    MOV 7, @2
    CMP l√§bel, l√§bel
; is everything after end ignored?!
Yes, otherwise this would be a problem
        </textarea>
        <div class='v-spacer'></div>
        <pre id='preprocessor_output'>preprocessor output</pre>
        <div class='v-spacer'></div>
        <pre id='assembler_output'>assembler output</pre>
    </div>

    <pre id='log'>nCode IDE v0.1</pre>
    <div id='toolbar'>
        <input type='button' value='assemble' onclick='doit()'>
        <input type='button' value='write to local storage' onclick='save()' id='save_button'>
        <input type='text' placeholder='warrior name' id='name'>
    </div>
</body>

</html>