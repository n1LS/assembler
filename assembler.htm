<html>

<head>
    <link href='https://fonts.googleapis.com/css?family=Overpass+Mono' rel='stylesheet'>
    <link href='https://schickt.de/font/px8x8.css' rel='stylesheet'>
    <link rel="stylesheet" type="text/css" href="style/style.css" media="screen" />

    <style>
        .gray {
            color: gray;
        }

        #container-top {
            height: 75vh;
            max-height: 75vh;
            width: 100vw;
            overflow: hidden;
        }

        #editor,
        #editor-nol,
        #assembler_output,
        #preprocessor_output {
            color: white;
            height: calc(75vh - 16px);
            max-height: calc(75 - 16px);
            background: #101010;
        }

        #editor-nol {
            float: left;
            width: 4em;
            text-align: right;
            padding-right: 1em;
        }

        #blank-out {
            bottom: 25%;
            width: 5em;
            height: 12px;
            background: #404040;
            position: absolute;
        }

        #preprocessor_output {
            overflow: scroll;
            width: 100%;
        }

        #editor {
            overflow: scroll;
            white-space: nowrap;
            width: calc(100% - 5em);
        }

        #assembler_output {
            overflow: scroll;
            width: 100%;
        }

        #editor-nol,
        .num {
            color: #aaaaaa;
        }

        #log {
            clear: both;
            height: calc(25% - 32px);
            overflow: scroll;
            background: #101010;
        }
    </style>

    <script src='rc-core.js'></script>
    <script src='rc-math.js'></script>
    <script src='rc-constants.js'></script>
    <script src='rc-address-modes.js'></script>
    <script src='rc-preprocessor.js'></script>
    <script src='rc-assembler.js'></script>
    <script src='rc-classes.js'></script>
    <script src='rc-instruction-set.js'></script>
    <script src='rc-instruction.js'></script>

    <script>

        var modified = false

        String.prototype.html = function () {
            const escape = [
                ['>', '&gt;'],
                ['<', '&lt;'],
            ]

            var html = this

            escape.forEach(item => {
                html = html.replace(item[0], item[1])
            })

            return html
        }

        function number_text(text) {
            var s = ''

            for (var i = 0; i < text.length; i++) {
                n = (1 + i + '').padStart(3)

                if (i % 10 == 9) {
                    s += `<u>${n}</u> ${text[i]}<br>`
                } else {
                    s += `<span class='num'>${n}</span> ${text[i]}<br>`
                }
            }

            return s
        }

        function preprocess() {
            var code = document.getElementById('editor').value
            var prepro = new Preprocessor()
            var output = prepro.preprocess(code)

            var content = number_text(output.code.split('\n'))
            document.getElementById('preprocessor_output').innerHTML = content

            html = '<span class="gray">'

            if (output.errors.length) {
                html += `<b>PREPROCESSOR ERRORS:</b>\n${output.errors.join('\n').html()}</b>\n\n`
            }

            if (output.warnings.length) {
                html += `<i>PREPROCESSOR WARNINGS:</i>\n${output.warnings.join('\n').html()}`
            }

            html += '</span>'

            document.getElementById('log').innerHTML = html

            return output
        }

        function assemble(code) {
            var assembler = new Assembler()
            var output = assembler.assemble(code)
            var content = number_text(output.listing.split('\n'))

            document.getElementById('assembler_output').innerHTML = content

            var html = '<br><span class="gray">'

            if (output.errors.length) {
                html += `\n<b>ERRORS:</b>\n${output.errors.join('\n').html()}</b>\n\n`
            }

            if (output.warnings.length) {
                html += `<i>WARNINGS:</i>\n${output.warnings.join('\n').html()}`
            }

            html += '</span>'

            document.getElementById('log').innerHTML += html

            return output
        }

        function changed() {
            var p = preprocess()

            if (p.errors.length == 0) {
                var a = assemble(p.code)

                if (a.errors.length == 0) {
                    modified = true
                    document.getElementById('log').innerHTML +=
                        '<span class="yay">ASSEMBLED SUCCESSFULLY.</span><br>'
                }

                document.getElementById('save_button').hidden = (a.errors.length > 0)
            } else {
                document.getElementById('assembler_output').innerHTML =
                    '<b>Preprocessor errors prevented assembly.</b>'
                document.getElementById('save_button').hidden = true
            }

            renumber_lines()
        }

        function renumber_lines() {
            var n = document.getElementById('editor').value.split('\n').length
            var s = ''

            for (var i = 1; i <= n; i++) {
                if (i % 10 == 0) {
                    s += `<div>${i}</div>`
                }
                else {
                    s += `${i}<br>`
                }
            }

            document.getElementById('editor-nol').innerHTML = s
        }

        function save() {
            var code = document.getElementById('editor').value
            var name = document.getElementById('name').value
            name = '#WRRR_' + name.replace(/ /g, '_')

            localStorage.setItem(name, code)

            document.getElementById('save_button').hidden = true
        }

        function scrolled() {
            var y = document.getElementById('editor')
            var e = document.getElementById('editor-nol')
            e.style.height = y.scrollHeight
            e.style.marginTop = `-${y.scrollTop}px`
        }

        function init() {
            // listen to messages from parent window
            window.addEventListener('message', message_handler, false)

            changed()
        }

        function message_handler(event) {
            items = event.data.split('::')
            action = items.shift(0)

            switch (action) {
                case 'load':
                    document.getElementById('editor').value = atob(items[0])
                    changed()
                    break
            }
        }

    </script>

</head>

<body onload='init()'>

        <div id='container-top' class='no-overflow'>
            <div class='left50 h100 no-overflow'>
                <h1>Source code</h1>
                <div id='editor-nol'></div>
                <div id='blank-out'></div>
                <textarea id='editor' autocomplete='off' autocorrect='off' autocapitalize='off' spellcheck='false' class='monospace' onkeyup='changed()' onscroll='scrolled()'>
20
1
2
3
4
5
6
7
8
9
30
1
2
3
4
57
8
9
20
1
2
3
4
5
6
7
8
9
30
1
2
3
4
5
6
7
8
9
407
8
9
20
1
2
3
4
5
6
7
8
9
30
1
2
3
4
5
6
7
8
9
40
6
7
8
9
40  

7
8
9
20
1
2
3
4
5
6
7
8
9
30
1
2
3
4
57
8
9
20
1
2
3
4
5
6
7
8
9
30
1
2
3
4
5
6
7
8
9
407
8
9
20
1
2
3
4
5
6
7
8
9
30
1
2
3
4
5
6
7
8
9
40
6
7
8
9
40                  
                </textarea>
            </div>

            <div div class='left30 h100'>
                <h1>Preprocessor output / Load file</h1>
                <pre id='preprocessor_output' class='monospace'>preprocessor output</pre>
            </div>

            <div class='left20 h100'>
                <h1>Assembly listing</h1>
                <pre id='assembler_output' class='monospace'>assembler output</pre>
            </div>

        </div>

        <pre id='log' class='monospace'></pre>

        <div class='toolbar'>
            <input type='button' value='assemble' onclick='changed()'>
            <input type='button' value='write to local storage' onclick='save()' id='save_button'>
            <input type='text' placeholder='warrior name' id='name'>
        </div>

</body>

</html>